# AI-Travel-Planner 部署与集成方案文档

## 1. 项目概述

AI-Travel-Planner是一个基于AI技术的旅行规划应用，能够根据用户需求自动生成详细的旅行计划，包括行程安排、预算估算、住宿推荐等功能。系统采用现代化前端技术栈，并集成了Supabase作为数据存储服务和智谱AI作为语言模型服务。

## 2. 技术架构

### 2.1 系统架构图

```
客户端 (React Web应用)
  |
  |-- Supabase Auth (用户认证)
  |-- Supabase Database (数据存储)
  |-- 智谱AI API (旅行计划生成)
  |-- Web Speech API (语音识别)
  |-- 百度地图API (地图展示)
```

### 2.2 技术栈

- **前端框架**: React 18.2.0
- **构建工具**: Vite 5.0.8
- **路由管理**: React Router 6.25.1
- **数据存储**: Supabase
- **语音识别**: Web Speech API
- **地图服务**: 百度地图API (react-bmapgl)
- **语言模型**: 智谱AI API (GLM-4)
- **容器化**: Docker + Nginx
- **CI/CD**: GitHub Actions

## 3. 数据库配置

### 3.1 Supabase配置

系统使用Supabase作为数据库和认证服务提供商。主要配置信息如下：

- **Supabase URL**: 通过环境变量 `VITE_SUPABASE_URL` 配置
- **Supabase Anon Key**: 通过环境变量 `VITE_SUPABASE_ANON_KEY` 配置

## 4. 服务层与API集成

### 4.1 核心服务模块

#### 4.1.1 supabaseClient.js

负责初始化Supabase客户端并提供认证功能：

- 用户注册
- 用户登录
- 用户注销
- 获取当前用户信息
- 监听认证状态变化

#### 4.1.2 travelPlanService.js

旅行计划核心服务：

- 处理活动预算
- 生成唯一计划名称
- 保存/更新/删除/查询旅行计划
- JSON序列化与反序列化
- 并发冲突处理与重试机制

#### 4.1.3 llmService.js

AI服务集成：

- 构建旅行计划提示词
- 调用智谱AI API
- 解析LLM响应
- 估算活动预算
- 错误处理与回退机制

#### 4.1.4 systemConfigService.js

系统配置服务：

- 保存用户系统配置
- 获取用户系统配置
- 删除用户系统配置
- 配置加密与解密

#### 4.1.5 speechRecognitionService.js

语音识别服务：

- 基于Web Speech API实现语音识别
- 语音输入处理流程
- 浏览器兼容性检查

#### 4.1.6 encryptionService.js

加密服务：

- 敏感数据加密与解密
- 配置对象加密与解密

### 4.2 第三方API依赖

#### 4.2.1 智谱AI API

- 端点：用户配置的`llmApiBaseUrl` + `/chat/completions`
- 认证：Bearer Token (apiKey)
- 模型：GLM-4
- 用途：生成旅行计划内容

#### 4.2.2 百度地图API

- 组件：react-bmapgl
- 用途：地图显示和位置展示

#### 4.2.3 Web Speech API

- 浏览器内置API
- 用途：语音识别和输入

## 5. 容器化部署

### 5.1 Docker配置

项目使用多阶段构建的Dockerfile：

```dockerfile
# 使用 Node 构建前端项目
FROM node:18 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 使用 Nginx 提供静态资源服务
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 5.2 Docker忽略文件

`.dockerignore` 配置避免不必要的文件被复制到镜像中：

- 依赖目录：node_modules
- 构建输出：dist
- 日志文件
- 编辑器配置文件
- 文档和测试文件

## 6. CI/CD配置

### 6.1 GitHub Actions工作流

项目使用GitHub Actions进行CI/CD，配置文件为`.github/workflows/docker.yml`，主要流程如下：

1. 触发条件：main分支推送
2. 执行环境：Ubuntu Latest
3. 构建步骤：
   - 拉取代码
   - 登录阿里云容器镜像服务
   - 构建Docker镜像
   - 推送镜像到阿里云镜像仓库
   - 导出镜像为tar文件
   - 上传tar文件到GitHub Release

### 6.2 密钥配置

CI/CD流程依赖以下GitHub Secrets：

- `ALIYUN_USERNAME`: 阿里云容器镜像服务用户名
- `ALIYUN_PASSWORD`: 阿里云容器镜像服务密码
- `ALIYUN_REGISTRY`: 阿里云容器镜像服务地址

## 7. 环境配置

### 7.1 环境变量

项目需要以下环境变量：

#### 7.1.1 开发环境

在`.env.development`文件中配置：

```
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

#### 7.1.2 生产环境

在Docker运行时挂载环境变量文件：

```
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### 7.2 用户配置

用户需要在系统中配置以下敏感信息（将被加密存储）：

- **LLM API Key**: 智谱AI API密钥
- **LLM API Base URL**: 智谱AI API基础URL
- **百度地图API Key**: 百度地图服务密钥

## 8. 部署流程

### 8.1 本地开发部署

1. 克隆代码仓库
2. 安装依赖：`npm install`
3. 配置环境变量（`.env.development`）
4. 启动开发服务器：`npm run dev`
5. 访问：http://localhost:5173

### 8.2 Docker本地构建与运行

1. 构建镜像：`docker build -t ai-travel-planner .`
2. 运行容器：
   ```bash
   docker run -d -p 8080:80 \
     -e VITE_SUPABASE_URL=your-supabase-url \
     -e VITE_SUPABASE_ANON_KEY=your-supabase-anon-key \
     ai-travel-planner
   ```
3. 访问：http://localhost:8080

### 8.3 生产环境部署

1. 推送代码到main分支，触发CI/CD流程
2. CI/CD自动构建并推送镜像到阿里云容器镜像服务
3. 在生产服务器上拉取镜像：`docker pull registry-url/smallseaaa/ai-travel-planner:latest`
4. 运行容器：
   ```bash
   docker run -d -p 80:80 \
     -e VITE_SUPABASE_URL=your-supabase-url \
     -e VITE_SUPABASE_ANON_KEY=your-supabase-anon-key \
     --restart unless-stopped \
     registry-url/smallseaaa/ai-travel-planner:latest
   ```

## 9. 集成测试

### 9.1 连接测试

项目包含Supabase连接测试脚本（`test-supabase-connection.js`），可用于验证数据库连接：

```bash
npm run test-supabase
```

### 9.2 功能测试

推荐的测试流程：

1. **用户认证测试**：注册、登录、注销功能
2. **旅行计划生成测试**：
   - 输入基本旅行需求
   - 验证AI生成的计划格式
   - 测试预算估算功能
3. **语音识别测试**：
   - 测试语音输入功能
   - 验证识别准确性
4. **数据存储测试**：
   - 保存计划并验证数据完整性
   - 编辑和删除计划
5. **系统配置测试**：
   - 配置API密钥
   - 验证加密存储

## 10. 安全注意事项

### 10.1 API密钥管理

- 所有API密钥通过加密方式存储在Supabase中
- 前端环境变量中不包含敏感的API密钥
- 密钥在本地加密后仅在需要时解密使用

### 10.2 数据安全

- 用户数据通过Supabase Auth进行身份验证和授权
- 数据库表使用user_id进行行级访问控制
- 敏感配置信息使用加密存储

## 11. 维护与监控

### 11.1 日志监控

- 容器日志：使用Docker日志系统收集Nginx访问日志
- 应用日志：前端应用日志通过浏览器控制台输出
- 建议集成第三方监控服务如Sentry进行错误追踪

### 11.2 常见问题排查

1. **API连接失败**：
   - 检查API密钥配置
   - 验证网络连接
   - 查看浏览器控制台错误信息

2. **数据库操作错误**：
   - 确认Supabase配置正确
   - 检查用户认证状态
   - 验证数据库权限设置

3. **构建失败**：
   - 检查依赖安装
   - 验证环境变量配置
   - 查看CI/CD日志
