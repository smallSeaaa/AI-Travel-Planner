# AI 旅行规划师 (AI Travel Planner) 部署与集成方案文档

## 1. 系统部署方案

### 1.1 环境需求

| 组件           | 版本/规格 | 用途                    |
| -------------- | --------- | ----------------------- |
| Node.js        | 18+       | JavaScript 运行环境     |
| npm/yarn       | 9+/1.22+  | 前端包管理工具          |
| Docker         | 20.10+    | 容器化部署              |
| Nginx          | 1.20+     | Web 服务器和反向代理    |
| Supabase CLI   | 1.80+     | Supabase 项目管理工具   |

### 1.2 目录结构

```
aitravelplanner/
├── frontend/          # 前端React+TypeScript项目
│   ├── public/
│   ├── src/
│   ├── package.json
│   └── Dockerfile
├── supabase/          # Supabase配置和迁移
│   ├── migrations/    # 数据库迁移脚本
│   ├── functions/     # Supabase Edge Functions
│   │   └── trip-generator/
│   └── config.toml    # Supabase配置文件
├── nginx/             # Nginx配置
│   └── default.conf
└── .env.example       # 环境变量示例
```

### 1.3 Docker 部署方案

#### 1.3.1 前端 Dockerfile

```dockerfile
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 1.3.2 Docker Compose 配置

```yaml
version: "3.8"

services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
```

### 1.4 环境变量配置

创建`.env`文件（基于`.env.example`模板）：

```dotenv
# Supabase 配置（前端使用）
NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key_here

# Supabase 私钥（仅用于部署和管理）
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# 第三方API配置（存储在Supabase环境变量中）
OPENAI_API_KEY=your_openai_api_key
XUNFEI_APPID=your_xunfei_appid
XUNFEI_API_KEY=your_xunfei_api_key
XUNFEI_API_SECRET=your_xunfei_api_secret
AMAP_API_KEY=your_amap_api_key
```

### 1.5 部署步骤

#### 1.5.1 Supabase 后端部署

1. **准备 Supabase 项目**
   - 在 [Supabase 官网](https://supabase.com) 创建新项目
   - 记录项目 URL 和 API 密钥

2. **部署数据库迁移**
   ```bash
   supabase login
   supabase link --project-ref your-project-ref
   supabase db push
   ```

3. **部署 Edge Functions**
   ```bash
   supabase functions deploy trip-generator --no-verify-jwt
   ```

#### 1.5.2 前端部署

1. **准备环境**
   - 安装 Docker
   - 克隆代码库

2. **配置环境变量**
   - 复制`.env.example`为`.env`
   - 设置正确的 Supabase URL 和匿名密钥

3. **构建和启动前端服务**
   ```bash
   docker-compose up -d --build
   ```

4. **验证部署**
   - 访问 `http://your-server-ip` 检查前端是否正常加载
   - 测试登录注册功能验证与 Supabase 的连接

## 2. CI/CD 配置

### 2.1 GitHub Actions 配置

创建`.github/workflows/ci-cd.yml`文件：

```yaml
name: AI Travel Planner CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Frontend Build and Test
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Build and Test Frontend
        working-directory: ./frontend
        run: |
          npm install
          npm run build
          npm run test -- --watchAll=false

  deploy:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 安装Supabase CLI
      - name: Install Supabase CLI
        run: |
          curl -L https://get.supabase.com/cli/install.sh | sh
          sudo mv supabase /usr/local/bin/

      # 登录Supabase
      - name: Login to Supabase
        run: supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # 部署数据库迁移
      - name: Deploy Database Migrations
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase db push

      # 部署Edge Functions
      - name: Deploy Supabase Edge Functions
        run: supabase functions deploy trip-generator --no-verify-jwt

      # 构建并推送前端Docker镜像
      - name: Login to Docker Registry
        run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Build and Push Frontend Image
        run: |
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/aitravelplanner/frontend:latest ./frontend
          docker push ${{ secrets.DOCKER_REGISTRY }}/aitravelplanner/frontend:latest
```

## 3. 第三方 API 集成方案

### 3.1 科大讯飞语音识别 API 集成

#### 3.1.1 准备工作

1. 在科大讯飞开放平台注册账号
2. 创建应用并获取 AppID、API Key 和 API Secret
3. 将密钥存储在 Supabase 环境变量中

#### 3.1.2 集成步骤

在 Supabase Edge Function 中实现语音识别：

```javascript
// supabase/functions/trip-generator/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabaseClient = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )
  
  try {
    const { audio, language } = await req.json()
    
    // 调用科大讯飞API进行语音识别
    const response = await fetch('https://api.xfyun.cn/v1/private/slr', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Appid': Deno.env.get('XUNFEI_APPID'),
        'Authorization': generateAuthHeader() // 实现授权头生成逻辑
      },
      body: JSON.stringify({
        audio,
        language
      })
    })
    
    const result = await response.json()
    return new Response(JSON.stringify({ text: result.text }), { status: 200 })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
```

### 3.2 高德地图 API 集成

#### 3.2.1 准备工作

1. 在高德地图开放平台注册账号
2. 创建应用并获取 API Key

#### 3.2.2 集成步骤

在前端 React 组件中集成高德地图：

```tsx
// src/components/MapComponent.tsx
import React, { useEffect, useRef } from 'react';

interface MapComponentProps {
  center?: [number, number];
  zoom?: number;
}

export const MapComponent: React.FC<MapComponentProps> = ({ 
  center = [116.397428, 39.90923], 
  zoom = 13 
}) => {
  const mapContainerRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    // 动态加载高德地图SDK
    const script = document.createElement('script');
    script.src = `https://webapi.amap.com/maps?v=2.0&key=${process.env.REACT_APP_AMAP_API_KEY}`;
    script.async = true;
    document.body.appendChild(script);
    
    script.onload = () => {
      if (mapContainerRef.current && window.AMap) {
        const map = new window.AMap.Map(mapContainerRef.current, {
          center,
          zoom,
          resizeEnable: true
        });
        
        // 添加控件
        map.addControl(new window.AMap.ToolBar());
      }
    };
    
    return () => {
      document.body.removeChild(script);
    };
  }, [center, zoom]);
  
  return <div ref={mapContainerRef} style={{ width: '100%', height: '400px' }} />;
};
```

### 3.3 OpenAI API 集成

#### 3.3.1 准备工作

1. 在 OpenAI 官网注册账号
2. 创建 API Key
3. 将密钥存储在 Supabase 环境变量中

#### 3.3.2 集成步骤

在 Supabase Edge Function 中实现 AI 行程生成：

```javascript
// supabase/functions/trip-generator/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabaseClient = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )
  
  try {
    const { userRequest, userId } = await req.json()
    
    // 调用OpenAI API生成行程计划
    const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${Deno.env.get('OPENAI_API_KEY')}`
      },
      body: JSON.stringify({
        model: 'gpt-4',
        messages: [
          { role: 'system', content: '你是一位专业的旅行规划师，擅长根据用户需求生成详细的旅行行程。' },
          { role: 'user', content: `请为以下旅行需求生成一个详细的行程计划：${userRequest}` }
        ],
        max_tokens: 2000,
        temperature: 0.7
      })
    })
    
    const openaiResult = await openaiResponse.json()
    const tripData = JSON.parse(openaiResult.choices[0].message.content)
    
    // 保存行程数据到Supabase
    const { data, error } = await supabaseClient.from('trips').insert([{
      user_id: userId,
      title: tripData.title || '新行程',
      destination: tripData.destination,
      start_date: tripData.startDate,
      end_date: tripData.endDate,
      trip_data: tripData,
      status: 'planned'
    }]).select()
    
    if (error) throw error
    
    return new Response(JSON.stringify({ trip: data[0] }), { status: 200 })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
```

## 4. API 密钥管理

### 4.1 密钥存储

1. **Supabase 环境变量存储**

   - 系统级 API 密钥（如 OpenAI、高德地图、科大讯飞）存储在 Supabase 项目的环境变量中
   - 使用 Supabase CLI 安全管理环境变量

2. **用户 API 密钥存储**
   - 用户的 API 密钥使用 AES-256 加密后存储在 Supabase 数据库中
   - 加密密钥存储在 Supabase 环境变量中，不在代码中硬编码

### 4.2 密钥使用安全措施

1. **最小权限原则**

   - Supabase 使用不同级别的 API 密钥：
     - `anon` 密钥：前端使用，受 Row Level Security 限制
     - `service_role` 密钥：仅用于服务端函数，拥有更高权限

2. **访问控制**

   - 使用 Supabase Row Level Security (RLS) 策略限制数据访问
   - 用户只能访问和管理自己的 API 密钥和数据

3. **密钥轮换**
   - 定期更新 Supabase 项目密钥
   - 为用户提供 API 密钥更新机制

### 4.3 监控与审计

1. **Supabase 审计日志**

   - 启用 Supabase 审计日志功能记录数据变更
   - 监控 API 密钥相关操作

2. **速率限制**
   - 在 Supabase Edge Functions 中实现 API 调用频率限制
   - 防止 API 密钥滥用
