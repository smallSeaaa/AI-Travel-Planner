# AI旅行规划师 (AI Travel Planner) 数据库设计文档

## 1. 数据库概述

本数据库设计基于关系型数据库PostgreSQL（Supabase内置），用于存储AI旅行规划师系统的用户信息、旅行计划、预算管理、偏好设置等核心数据。

## 2. 数据库表结构

### 2.1 用户表 (`users`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 用户ID (Supabase Auth生成) |
| `username` | `VARCHAR(50)` | `NOT NULL` | 用户名 |
| `email` | `VARCHAR(100)` | `UNIQUE NOT NULL` | 邮箱 |
| `avatar` | `VARCHAR(255)` | `NULL` | 头像URL |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |
| `last_login_at` | `TIMESTAMP` | `NULL` | 最后登录时间 |
| `status` | `SMALLINT` | `DEFAULT 1` | 状态(0:禁用, 1:启用) |

### 2.2 用户偏好表 (`user_preferences`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 偏好ID |
| `user_id` | `UUID` | `REFERENCES auth.users(id)` | 用户ID (关联Supabase Auth表) |
| `preference_type` | `VARCHAR(50)` | `NOT NULL` | 偏好类型(如:food, transport, accommodation) |
| `preference_value` | `VARCHAR(255)` | `NOT NULL` | 偏好值 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.3 旅行计划表 (`trips`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 旅行计划ID |
| `user_id` | `UUID` | `REFERENCES auth.users(id)` | 用户ID (关联Supabase Auth表) |
| `title` | `VARCHAR(100)` | `NOT NULL` | 行程标题 |
| `description` | `TEXT` | `NULL` | 行程描述 |
| `destination` | `VARCHAR(100)` | `NOT NULL` | 目的地 |
| `start_date` | `DATE` | `NOT NULL` | 开始日期 |
| `end_date` | `DATE` | `NOT NULL` | 结束日期 |
| `total_budget` | `DECIMAL(12,2)` | `NOT NULL` | 总预算 |
| `people_count` | `INTEGER` | `DEFAULT 1` | 同行人数 |
| `is_public` | `BOOLEAN` | `DEFAULT false` | 是否公开 |
| `status` | `VARCHAR(20)` | `DEFAULT 'draft'` | 状态(draft, planned, completed, cancelled) |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |
| `trip_data` | `JSONB` | `NULL` | AI生成的完整行程数据 (PostgreSQL JSONB类型) |

### 2.4 每日行程表 (`daily_itineraries`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 每日行程ID |
| `trip_id` | `INTEGER` | `REFERENCES trips(id) ON DELETE CASCADE` | 所属旅行计划ID |
| `day_number` | `INTEGER` | `NOT NULL` | 第几天 |
| `date` | `DATE` | `NOT NULL` | 日期 |
| `title` | `VARCHAR(100)` | `NOT NULL` | 当日标题 |
| `description` | `TEXT` | `NULL` | 当日描述 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.5 行程项目表 (`itinerary_items`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 行程项目ID |
| `daily_itinerary_id` | `INTEGER` | `REFERENCES daily_itineraries(id) ON DELETE CASCADE` | 所属每日行程ID |
| `item_type` | `VARCHAR(50)` | `NOT NULL` | 项目类型(attraction, restaurant, accommodation, transport) |
| `name` | `VARCHAR(255)` | `NOT NULL` | 名称 |
| `description` | `TEXT` | `NULL` | 描述 |
| `start_time` | `TIME` | `NULL` | 开始时间 |
| `end_time` | `TIME` | `NULL` | 结束时间 |
| `latitude` | `DECIMAL(10,7)` | `NULL` | 纬度 |
| `longitude` | `DECIMAL(10,7)` | `NULL` | 经度 |
| `address` | `VARCHAR(255)` | `NULL` | 地址 |
| `contact` | `VARCHAR(100)` | `NULL` | 联系方式 |
| `website` | `VARCHAR(255)` | `NULL` | 网站 |
| `image_url` | `VARCHAR(255)` | `NULL` | 图片URL (存储于Supabase Storage) |
| `price_estimate` | `DECIMAL(10,2)` | `NULL` | 预估价格 |
| `rating` | `DECIMAL(3,1)` | `NULL` | 评分 |
| `order_index` | `INTEGER` | `NOT NULL` | 顺序索引 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.6 预算表 (`budgets`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 预算ID |
| `trip_id` | `INTEGER` | `REFERENCES trips(id) ON DELETE CASCADE` | 所属旅行计划ID |
| `category` | `VARCHAR(50)` | `NOT NULL` | 预算类别(transport, accommodation, food, attraction, shopping, other) |
| `allocated_amount` | `DECIMAL(12,2)` | `NOT NULL` | 分配金额 |
| `actual_amount` | `DECIMAL(12,2)` | `DEFAULT 0` | 实际花费 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.7 费用记录表 (`expenses`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 费用记录ID |
| `trip_id` | `INTEGER` | `REFERENCES trips(id) ON DELETE CASCADE` | 所属旅行计划ID |
| `budget_id` | `INTEGER` | `REFERENCES budgets(id)` | 所属预算类别ID |
| `amount` | `DECIMAL(12,2)` | `NOT NULL` | 费用金额 |
| `description` | `VARCHAR(255)` | `NOT NULL` | 费用描述 |
| `expense_date` | `DATE` | `NOT NULL` | 支出日期 |
| `payment_method` | `VARCHAR(50)` | `NULL` | 支付方式 |
| `receipt_image` | `VARCHAR(255)` | `NULL` | 收据图片URL (存储于Supabase Storage) |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.8 API密钥表 (`api_keys`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 密钥ID |
| `user_id` | `UUID` | `REFERENCES auth.users(id)` | 用户ID (关联Supabase Auth表) |
| `service_type` | `VARCHAR(50)` | `NOT NULL` | 服务类型(openai, xunfei, amap) |
| `api_key_encrypted` | `VARCHAR(255)` | `NOT NULL` | 加密后的API密钥 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |
| `expires_at` | `TIMESTAMP` | `NULL` | 过期时间 |

## 3. 关系图

```mermaid
erd
    users { 
        UUID id PK 
        VARCHAR username 
        VARCHAR email 
        VARCHAR avatar 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
        TIMESTAMP last_login_at 
        SMALLINT status 
    }

    user_preferences { 
        SERIAL id PK 
        UUID user_id FK 
        VARCHAR preference_type 
        VARCHAR preference_value 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
    }

    trips { 
        SERIAL id PK 
        UUID user_id FK 
        VARCHAR title 
        TEXT description 
        VARCHAR destination 
        DATE start_date 
        DATE end_date 
        DECIMAL total_budget 
        INTEGER people_count 
        BOOLEAN is_public 
        VARCHAR status 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
        JSONB trip_data 
    }

    daily_itineraries { 
        SERIAL id PK 
        INTEGER trip_id FK 
        INTEGER day_number 
        DATE date 
        VARCHAR title 
        TEXT description 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
    }

    itinerary_items { 
        SERIAL id PK 
        INTEGER daily_itinerary_id FK 
        VARCHAR item_type 
        VARCHAR name 
        TEXT description 
        TIME start_time 
        TIME end_time 
        DECIMAL latitude 
        DECIMAL longitude 
        VARCHAR address 
        VARCHAR contact 
        VARCHAR website 
        VARCHAR image_url 
        DECIMAL price_estimate 
        DECIMAL rating 
        INTEGER order_index 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
    }

    budgets { 
        SERIAL id PK 
        INTEGER trip_id FK 
        VARCHAR category 
        DECIMAL allocated_amount 
        DECIMAL actual_amount 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
    }

    expenses { 
        SERIAL id PK 
        INTEGER trip_id FK 
        INTEGER budget_id FK 
        DECIMAL amount 
        VARCHAR description 
        DATE expense_date 
        VARCHAR payment_method 
        VARCHAR receipt_image 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
    }

    api_keys { 
        SERIAL id PK 
        UUID user_id FK 
        VARCHAR service_type 
        VARCHAR api_key_encrypted 
        TIMESTAMP created_at 
        TIMESTAMP updated_at 
        TIMESTAMP expires_at 
    }

    auth.users ||--o{ user_preferences : has 
    auth.users ||--o{ trips : creates 
    auth.users ||--o{ api_keys : owns 
    trips ||--o{ daily_itineraries : contains 
    trips ||--o{ budgets : has 
    trips ||--o{ expenses : records 
    daily_itineraries ||--o{ itinerary_items : includes 
    budgets ||--o{ expenses : categorizes 
```

## 4. 索引设计

| 表名 | 索引名 | 索引类型 | 索引字段 | 目的 |
|-----|-------|---------|---------|------|
| users | idx_email | UNIQUE | email | 加速邮箱查询，确保唯一性 |
| users | idx_username | INDEX | username | 加速用户名查询 |
| user_preferences | idx_user_preference | INDEX | user_id, preference_type | 加速用户偏好查询 |
| trips | idx_user_trips | INDEX | user_id | 加速查询用户的所有行程 |
| trips | idx_trip_dates | INDEX | start_date, end_date | 加速日期范围查询 |
| daily_itineraries | idx_trip_days | INDEX | trip_id, day_number | 加速查询行程的某一天 |
| itinerary_items | idx_daily_items | INDEX | daily_itinerary_id, order_index | 加速查询和排序每日行程项 |
| budgets | idx_trip_budgets | INDEX | trip_id | 加速查询行程预算 |
| expenses | idx_trip_expenses | INDEX | trip_id, expense_date | 加速查询行程费用记录 |
| api_keys | idx_user_service_keys | INDEX | user_id, service_type | 加速查询用户的特定服务密钥 |

## 5. 数据安全

1. **密码加密**：利用Supabase Auth自动处理密码加密和安全存储
2. **API密钥加密**：使用AES-256加密API密钥，密钥存储在Supabase环境变量中
3. **数据传输加密**：所有API通信使用HTTPS加密
4. **SQL注入防护**：通过Supabase SDK的参数化查询自动防止SQL注入
5. **定期备份**：Supabase提供自动数据库备份服务
6. **权限控制**：使用Supabase Row Level Security (RLS) 策略确保用户只能访问自己的数据
7. **文件安全**：使用Supabase Storage存储用户文件，配合适当的访问控制